5/20 필기



저번시간에는 adc를 돌리는데 어느타이밍에 맞추는지는 안결정

제일빠른속도로 adc가 반복

그러다보니 plotting하는 그래프에서 너무 빨리들어와서 데이터의 확인 불가

따라서 타이머 인터럽트를 써서 ex) 0.5s마다 adc interrupt 발생 하는식으로 함  

timer2를 사용할거임

헤더파일에 다 작성되어있음



실습

set_timer2만든다



보드의  

TIM2_PSC 는 Prescaler  

f / TIM_PSC + 1인데 PSC에 84 - 1 함 

f/ 84-1+1

f/84

84Mhz / 84 = 1Mhz

1초마다 1M진동

그래서 frequency를 1Mhz로 함 

따라서 1ms 마다 1번 진동 (Interrupt) 발생

​	

IRQ 발생 한것은 STATUS 레지스터에 뭔가 바꼈기때문에 들어온거고 

따라서 들어온 이후에는 SET 된 FLAG를 Clear해줌

일단은  1초마다 led깜빡이는거를했다

![1초 깜빠임](C:\Users\성한\Desktop\임베디드시스템설계실험\5.20수업\1초 깜빠임.PNG)

그다음 0.1초마다 adc값을 받기해봄

ADC_CR2 초기화 해주던거를 저안에 넣어서 ADC가 무조건 계속 안받고 타이머에 

영향 받게 해줌 저위의 IF구문에 들어감

아두이노 PLOTTER열어서 시각적으로 확인해보면 잘받아짐

저번시간에는 존나 빨리 받아서 아두이노에 표시 업로드가 끊겨서 나오는데

이번에는 천천히 값을 줘서 잘나옴 



실습 끝

15:00

새로운거 시작



gnuplot 

txt파일을 위 프로그램을통해 그래프로 바꿔주는 프로그램

sudo apt install gnuplot 설치

cui 명령 창에  gnuplot치면 사용가능

touch는 핀 파일 생성

mkdir는 디렉토리 파일 생성



숫자 값을 텍스트 파일에 입력하는 것을 만들거임

y = 5x + 10가 있으면

문서파일에 x y 쭉 출력되도록 만들어볼게요

hello.c 만들고 파일 입출력 함수써서 out.txt 에 쓰기 해봄

out.txt의 값을 그래프로 그려주는게 gnuplot임

out.txt가 들어있는 output폴더에서 gnuplot입력 하여 사용

plot "out.txt" using 1:2 title "Example" with lines lw 3

얘도 gdb처럼 스크립트화 bar.bat 사용 나는 bar.txt로 바꿔보았다

tree 명령어 사용해서 봤음



sh 는 shell 에서씀  

bat 붙이긴했는데 확장자는 txt로 바꿔도 상관없음 



16 : 00교수님 등장 

프로젝트를 하기위한 이론 수업 잠깐할거임



기말시험이 2주 뒤에 발표로 대체 

프로젝트가 뭔지 알려주는 시간

리포트를 써서 발표  하고싶은사람만 인데  웬만하면 하셈



외부에 변하는 값을 센서를 통하여 전압 또는 전류로 변환합니다잉



sw로 체크 즉 cpu로  polling으로 계속 체킹

지난주에 한 adc 첫 방식으로 하면 cpu가 계속 돌아가서 에너지를 엄청 씀

근데 이번에 timer연동해서 하면 적절하게 잘 저장 됨 



모든 임의의 신호는 정현파의 합으로 나타낼수있다!!! 

새로운 폴더 생성 harmonics

1hz의 정현파 = 1초에 2파이 지나감

sin 2pi ft  ft =1

진폭 5v에  을 100point찍은 그래프 생성 



문제

12bit resolution의 ADC에서  5볼트를 하면 한 비트가 가지는 5볼트의 범위는?

한 y범위는 2^12분의 5볼트

5/2^12가 한비트의 값이 되는거임 즉 

쭉 실행해보면

정현파 절반만 나옴

200Hz인데 

샘플링을 100까지만 해서 PI까지만 나감 각주파수

따라서 i를 200까지 하면 한 파를 샘플링 가능 i가 관찰하고싶은 샘플링 개수

![샘플링 갯수](C:\Users\성한\Desktop\임베디드시스템설계실험\5.20수업\샘플링 갯수.PNG)

여기서 i = 200으로 바꾸면댐 

i는 샘플링 개수여서 늘렸다 줄였다 할수있음 

따라서 관찰하고자 하는 신호의 2배로 샘플링해줘야한다

* 나이퀴스트 주파수!!!!에 대한 내용

bar.bat에서 impulse사용할 수도 있다~ with impulses lw 2이런식으로



int hi는 들어오는 신호의 속도임  외부신호

sample speed =  F  이거는 내부 cpu에서 처리하는 변수	

sample depth = i 	이거도

harmonics = hi 이것만 외부의 요인임 (목소리 등) 목소리는 20kHz

휴대폰에서 사람이 말하는 20khz는 adc를 연산하는 cpu입장에서는 1달에 한번 데이터 전송하는것처럼 느리게 와서  이산적인 값이 연속ㅇ적으로 느껴지게 되는것임.

FFT

무한한 정현파 주파수의 합은 임펄스 파로 될수있다. f1 + f2 + f3 + f4 + ....

자연계에서는 임펄스 엣지가 없다 사람이 만들었음 retangular pulse 

clock도 pulse임

자 그리고 sign pulse를 합쳐서 retangular pulse를 만들어보자

![심플한 예제 캡처](C:\Users\성한\Desktop\임베디드시스템설계실험\5.20수업\심플한 예제 캡처.PNG)

그전에꺼 저장

자 2중 for문 할건데 안에꺼는 

1 3 5 의 정현파를 합치는데 그거에대해 코딩

성분 32 개를 합침 1 3 5 ... 개수는 32개

고주파수로 갈수록  진폭이 작아지는것도 표현해야함 

![펄스파](C:\Users\성한\Desktop\임베디드시스템설계실험\5.20수업\펄스파.PNG)

![펄스파 코드](C:\Users\성한\Desktop\임베디드시스템설계실험\5.20수업\펄스파 코드.PNG)



fourier transform 

같은 신호를 내적하면 항상 양수만 나오고 가장 큰 값이 나옴 

 sigma 0 ~ inf (f(t) * sin2pi * f_0 * t)

fft noise cancling 에 



미션 

uart로 전송해서 주파수 분석 

f축으로 plot하는것을 프로젝트로 한다.

여기서 추가해서 발표하면 

plot은 pc에서 하고 

처리과정은 flash한 mcu보드에서 계산하고 mcu를 통해 반환 하는거임 

우분투에서 plot하는거 아니다.

spectrum analyzor 만들기 2주간 하고

2주뒤에 리포트 발표하고 추가로 2주뒤에 창의적 아이디어를 내어서 mcu보드를 이용해서 하는게 최종 임

이 수업을 통해서 했던것을 기반으로 해야함 



2주뒤의 발표를 가볍게라도 해라 이거는 위의 미션과 관계없고 그냥 아이디어 발표 